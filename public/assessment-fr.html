<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√âvaluation des comp√©tences GP | Passez le test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
            stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917' }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-[#0b0b14] min-h-screen">
  <!-- Header -->
  <header class="border-b border-[#1e1e35] bg-[#0b0b14]/95 sticky top-0 z-50">
    <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
      <a href="/index-fr.html" class="flex items-center gap-3 text-white font-semibold text-lg">
        <div class="w-8 h-8 bg-gradient-to-br from-brand-500 to-brand-600 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        Comp√©tences<span class="text-brand-500">GP</span>
      </a>
      <div id="headerUserInfo" class="flex items-center gap-4">
        <a href="/assessment.html" class="text-slate-400 hover:text-white text-sm">EN</a>
        <a href="/index-fr.html" class="text-slate-400 hover:text-white text-sm transition-colors">‚Üê Retour</a>
      </div>
    </div>
  </header>
  
  <!-- Auth Required Modal -->
  <div id="authModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" style="display: none;">
    <div class="bg-[#131320] border border-[#1e1e35] rounded-2xl p-8 max-w-md w-full">
      <div class="text-center mb-6">
        <div class="text-5xl mb-4">üîê</div>
        <h2 class="text-2xl font-bold text-white mb-2">Compte gratuit requis</h2>
        <p class="text-slate-300">Cr√©ez un compte gratuit pour passer l'√©valuation et sauvegarder vos r√©sultats.</p>
      </div>
      <div class="space-y-3">
        <a href="/api/auth/google" onclick="localStorage.setItem('redirect_after_auth', '/assessment-fr.html')" class="flex items-center justify-center gap-3 w-full py-3 px-6 bg-white hover:bg-slate-100 text-gray-800 font-semibold rounded-lg text-center transition-colors">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continuer avec Google
        </a>
        <div class="flex items-center gap-3"><div class="flex-1 h-px bg-[#1e1e35]"></div><span class="text-slate-500 text-xs">OU</span><div class="flex-1 h-px bg-[#1e1e35]"></div></div>
        <a href="/index-fr.html#register" onclick="localStorage.setItem('redirect_after_auth', '/assessment-fr.html')" class="block w-full py-3 px-6 bg-brand-500 hover:bg-brand-600 text-white font-bold rounded-lg text-center transition-colors">
          Cr√©er un compte gratuit
        </a>
        <a href="/index-fr.html#login" onclick="localStorage.setItem('redirect_after_auth', '/assessment-fr.html')" class="block w-full py-3 px-6 bg-[#1a1a2e] hover:bg-[#2a2a45] text-white font-bold rounded-lg text-center transition-colors">
          Se connecter
        </a>
      </div>
      <p class="text-center text-slate-500 text-sm mt-6">Gratuit pour toujours ‚Ä¢ Aucune carte de cr√©dit</p>
    </div>
  </div>
  
  <div id="app"></div>

  <script>
    // Auth check
    let currentUser = null;
    let assessmentId = null;
    const authToken = localStorage.getItem('auth_token');
    
    async function checkAuth() {
      if (!authToken) {
        document.getElementById('authModal').style.display = 'flex';
        return false;
      }
      try {
        const response = await fetch('/api/auth/me', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!response.ok) throw new Error('Non authentifi√©');
        const data = await response.json();
        currentUser = data.user;
        document.getElementById('headerUserInfo').innerHTML = `
          <a href="/assessment.html" class="text-slate-400 hover:text-white text-sm">EN</a>
          <span class="text-slate-400 text-sm">Bonjour, <span class="text-white font-medium">${currentUser.name}</span></span>
          <a href="/dashboard-fr.html" class="text-slate-400 hover:text-white text-sm transition-colors">Mes √©valuations</a>
        `;
        if (currentUser.name && !state.profile.name) {
          state.profile.name = currentUser.name;
        }
        return true;
      } catch (e) {
        localStorage.removeItem('auth_token');
        document.getElementById('authModal').style.display = 'flex';
        return false;
      }
    }
    
    // State management
    const state = {
      currentStep: 'welcome',
      profile: { name: '', title: '', organization: '', experience: '', certifications: [] },
      objectives: { goal: '', timeline: '12', learningStyle: 'balanced' },
      scores: {},
      expandedSkill: null,
      isGenerating: false
    };

    // ========== DOMAINES DE COMP√âTENCES AVEC GRILLES D'√âVALUATION ==========
    const SKILL_AREAS = [
      { 
        id: 'basics', name: 'Fondamentaux GP', description: 'D√©finitions, standards, cycle de vie projet',
        rubric: {
          1: { label: 'Novice', criteria: ["Je suis nouveau dans les concepts de gestion de projet", "Je ne peux pas d√©finir ce qu'est un projet vs les op√©rations", "Je ne connais pas la diff√©rence entre projet, programme et portefeuille"] },
          2: { label: 'D√©butant', criteria: ["Je comprends ce qu'est un projet (temporaire, livrable unique)", "J'ai entendu parler de PMI/PMBOK mais je ne l'ai pas √©tudi√©", "Je sais que les projets ont des phases mais je ne peux pas les nommer"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux expliquer les 5 groupes de processus (D√©marrage, Planification, Ex√©cution, S&C, Cl√¥ture)", "Je comprends la triple contrainte (contenu, d√©lais, co√ªts)", "Je sais ce qu'est un BGP et ses fonctions de base"] },
          4: { label: 'Comp√©tent', criteria: ["Je peux appliquer les domaines de connaissance PMBOK dans de vrais projets", "Je comprends les diff√©rentes m√©thodologies GP et quand les utiliser", "Je peux expliquer les crit√®res de succ√®s d'un projet aux parties prenantes"] },
          5: { label: 'Expert', criteria: ["Je peux concevoir des cadres GP pour des organisations", "Je mentor d'autres personnes sur les fondamentaux GP", "Je contribue aux standards GP ou j'ai publi√© du contenu GP"] }
        }
      },
      { 
        id: 'agile', name: 'M√©thodes Agile pour GP', description: "Comprendre les approches agiles pour g√©rer ou travailler avec des √©quipes agiles",
        rubric: {
          1: { label: 'Novice', criteria: ["J'ai entendu parler d'Agile mais je ne comprends pas comment √ßa diff√®re du GP traditionnel", "Je ne sais pas ce qu'est un sprint ou une it√©ration", "Je n'ai jamais travaill√© avec ou g√©r√© une √©quipe Agile"] },
          2: { label: 'D√©butant', criteria: ["Je comprends les valeurs Agile et les bases du Manifeste Agile", "Je sais que Scrum a des r√¥les comme Product Owner et Scrum Master", "J'ai particip√© √† des m√™l√©es quotidiennes ou des revues de sprint"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux expliquer quand utiliser Agile vs Cascade", "Je comprends la v√©locit√©, les points d'effort et les graphiques d'avancement", "Je peux travailler efficacement avec des √©quipes Agile en tant que GP"] },
          4: { label: 'Comp√©tent', criteria: ["Je peux g√©rer des projets hybrides (Agile + Cascade)", "J'int√®gre les √©quipes Agile dans la gouvernance projet traditionnelle", "Je sais quand recommander une approche Agile vs pr√©dictive"] },
          5: { label: 'Expert', criteria: ["Je peux concevoir des cadres hybrides pour des organisations", "Je conseille la direction sur la transformation Agile d'une perspective GP", "Je forme des GP sur le travail avec les m√©thodologies Agile"] }
        }
      },
      { 
        id: 'product', name: 'Gestion de produit', description: 'Vision, feuilles de route, analyses de rentabilit√©',
        rubric: {
          1: { label: 'Novice', criteria: ["Je ne connais pas la diff√©rence entre gestion de projet et gestion de produit", "Je n'ai jamais cr√©√© d'analyse de rentabilit√©", "Je ne sais pas ce qu'est une feuille de route produit"] },
          2: { label: 'D√©butant', criteria: ["Je comprends que les produits ont des cycles de vie", "Je peux contribuer √† une analyse de rentabilit√© avec guidance", "J'ai vu des feuilles de route produit mais je n'en ai pas cr√©√©"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux cr√©er un √©nonc√© de vision produit de base", "Je peux construire une analyse de rentabilit√© avec analyse de ROI", "Je comprends les concepts d'ad√©quation produit-march√©"] },
          4: { label: 'Comp√©tent', criteria: ["Je peux d√©velopper et maintenir des feuilles de route produit", "Je prends des d√©cisions de priorisation bas√©es sur les donn√©es", "Je travaille efficacement avec les propri√©taires de produit et parties prenantes"] },
          5: { label: 'Expert', criteria: ["J'ai lanc√© plusieurs produits avec succ√®s", "Je peux d√©finir une strat√©gie produit align√©e aux objectifs d'affaires", "Je mentor des gestionnaires de produit"] }
        }
      },
      { 
        id: 'initiation', name: 'D√©marrage de projet', description: 'Charte, parties prenantes, lancement',
        rubric: {
          1: { label: 'Novice', criteria: ["Je ne sais pas ce qu'est une charte de projet", "Je n'ai jamais identifi√© formellement les parties prenantes d'un projet", "Je n'ai jamais dirig√© ou organis√© un lancement de projet"] },
          2: { label: 'D√©butant', criteria: ["Je comprends pourquoi nous avons besoin d'une charte de projet", "Je peux lister les parties prenantes √©videntes (commanditaire, √©quipe, client)", "J'ai particip√© √† des r√©unions de lancement"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux r√©diger une charte de projet avec objectifs et contraintes", "J'utilise des outils d'analyse des parties prenantes (grille pouvoir/int√©r√™t)", "Je peux planifier et animer une r√©union de lancement efficace"] },
          4: { label: 'Comp√©tent', criteria: ["Je cr√©e des chartes qui obtiennent rapidement l'adh√©sion du commanditaire", "J'identifie proactivement les parties prenantes cach√©es et leurs besoins", "J'adapte les activit√©s de d√©marrage √† la taille et au type de projet"] },
          5: { label: 'Expert', criteria: ["J'ai standardis√© les processus de d√©marrage pour des organisations", "Je coach d'autres sur les strat√©gies de gestion des parties prenantes", "Je peux d√©marrer des programmes complexes multi-parties prenantes"] }
        }
      },
      { 
        id: 'scope', name: 'Gestion du contenu', description: 'SDP, exigences, contr√¥le du contenu',
        rubric: {
          1: { label: 'Novice', criteria: ["Je ne sais pas ce qu'est une SDP (Structure de D√©coupage du Projet)", "J'ai du mal √† d√©finir des exigences projet claires", "J'ai v√©cu la d√©rive du contenu mais je ne savais pas comment la pr√©venir"] },
          2: { label: 'D√©butant', criteria: ["Je comprends que la SDP d√©compose le travail en √©l√©ments g√©rables", "Je peux documenter des exigences de base avec guidance", "Je sais que la d√©rive du contenu est mauvaise mais je ne sais pas comment la contr√¥ler"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux cr√©er une SDP en suivant la r√®gle des 100%", "Je recueille les exigences via entrevues et ateliers", "J'utilise le contr√¥le des changements pour g√©rer les modifications de contenu"] },
          4: { label: 'Comp√©tent', criteria: ["Je cr√©e des dictionnaires de SDP d√©taill√©s pour des projets complexes", "J'anime des sessions JAD et utilise plusieurs techniques d'√©licitation", "Je dis efficacement 'non' √† la d√©rive tout en maintenant les relations"] },
          5: { label: 'Expert', criteria: ["Je con√ßois des cadres de gestion du contenu pour des organisations", "Je g√®re des exigences tr√®s ambigu√´s dans des projets innovants", "Je forme d'autres sur l'ing√©nierie des exigences et la cr√©ation de SDP"] }
        }
      },
      { 
        id: 'time', name: 'Gestion du temps', description: '√âch√©ancier, chemin critique, d√©pendances',
        rubric: {
          1: { label: 'Novice', criteria: ["Je ne sais pas comment cr√©er un √©ch√©ancier de projet", "Je n'ai jamais entendu parler du chemin critique ou des d√©pendances", "J'ai du mal √† estimer combien de temps les t√¢ches prendront"] },
          2: { label: 'D√©butant', criteria: ["Je peux cr√©er une simple liste de t√¢ches avec des dates", "Je comprends que les t√¢ches peuvent d√©pendre les unes des autres", "J'ai utilis√© des diagrammes de Gantt mais je ne les ai pas cr√©√©s moi-m√™me"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux construire un diagramme de Gantt avec d√©pendances (FD, DD, FF, DF)", "Je comprends et peux calculer le chemin critique", "J'utilise l'estimation √† 3 points pour des dur√©es plus pr√©cises"] },
          4: { label: 'Comp√©tent', criteria: ["Je peux compresser ou chevaucher des √©ch√©anciers au besoin", "J'effectue le nivellement des ressources pour optimiser les affectations", "J'identifie proactivement les risques d'√©ch√©ancier et construis des tampons"] },
          5: { label: 'Expert', criteria: ["J'utilise la simulation Monte Carlo pour l'analyse des risques d'√©ch√©ancier", "J'ai g√©r√© des √©ch√©anciers pour des programmes de 100+ activit√©s", "J'optimise les √©ch√©anciers √† travers plusieurs projets (niveau portefeuille)"] }
        }
      },
      { 
        id: 'cost', name: 'Gestion des co√ªts', description: 'Budget, valeur acquise, pr√©visions',
        rubric: {
          1: { label: 'Novice', criteria: ["Je n'ai jamais cr√©√© ou g√©r√© un budget de projet", "Je ne sais pas ce qu'est la Gestion de la Valeur Acquise (GVA)", "Je ne peux pas expliquer la diff√©rence entre les types d'estimations"] },
          2: { label: 'D√©butant', criteria: ["Je comprends que les projets ont besoin de budgets avec contingence", "J'ai entendu parler des m√©triques GVA comme IPC et IPD", "Je peux suivre les co√ªts r√©els vs budget √† un niveau de base"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux cr√©er une estimation de co√ªts ascendante", "Je peux calculer les m√©triques GVA (VP, VA, CR, √âD, √âC, IPD, IPC)", "Je produis des rapports de co√ªts et des explications des √©carts"] },
          4: { label: 'Comp√©tent', criteria: ["Je pr√©vois les co√ªts finaux en utilisant les formules de CAF", "Je g√®re des budgets projet de plus de 500K$ avec confiance", "J'utilise les donn√©es de co√ªts pour prendre des d√©cisions de ressources et de contenu"] },
          5: { label: 'Expert', criteria: ["J'ai g√©r√© des budgets de plus de 5M$ avec financement complexe", "Je con√ßois des syst√®mes de gestion des co√ªts pour des organisations", "Je forme d'autres sur la GVA et les contr√¥les financiers de projet"] }
        }
      },
      { 
        id: 'quality', name: 'Gestion de la qualit√©', description: 'AQ/CQ, co√ªt de la qualit√©, normes',
        rubric: {
          1: { label: 'Novice', criteria: ["Je ne connais pas la diff√©rence entre AQ et CQ", "Je n'ai jamais cr√©√© de plan qualit√©", "Je ne connais pas les outils qualit√© (Pareto, Ishikawa, etc.)"] },
          2: { label: 'D√©butant', criteria: ["Je comprends que l'AQ pr√©vient les d√©fauts, le CQ les d√©tecte", "Je sais que les tests font partie du contr√¥le qualit√©", "J'ai particip√© √† des revues qualit√©"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux cr√©er un plan de gestion de la qualit√©", "J'utilise des outils qualit√© comme les listes de contr√¥le et les cartes de contr√¥le", "Je comprends le co√ªt de la qualit√© (pr√©vention vs co√ªts de d√©faillance)"] },
          4: { label: 'Comp√©tent', criteria: ["Je con√ßois des m√©triques qualit√© et des crit√®res d'acceptation", "Je dirige des audits qualit√© et des initiatives d'am√©lioration continue", "J'√©quilibre les co√ªts qualit√© avec les contraintes du projet"] },
          5: { label: 'Expert', criteria: ["J'implante des cadres qualit√© (Six Sigma, TQM) au niveau organisationnel", "Je suis certifi√© en m√©thodologies qualit√© (Ceinture Noire Six Sigma)", "Je forme d'autres sur les pratiques de gestion de la qualit√©"] }
        }
      },
      { 
        id: 'resources', name: 'Gestion des ressources', description: "Constitution d'√©quipe, RACI, allocation",
        rubric: {
          1: { label: 'Novice', criteria: ["Je n'ai jamais constitu√© ou dirig√© une √©quipe projet", "Je ne sais pas ce qu'est une matrice RACI", "J'ai du mal √† estimer les besoins en ressources"] },
          2: { label: 'D√©butant', criteria: ["Je comprends que les √©quipes ont besoin de r√¥les et responsabilit√©s clairs", "Je sais que RACI signifie Responsable, Imputable, Consult√©, Inform√©", "Je peux demander des ressources mais je ne g√®re pas la capacit√©"] },
          3: { label: 'Interm√©diaire', criteria: ["Je cr√©e des matrices RACI pour les livrables du projet", "J'estime les besoins en ressources et cr√©e des calendriers de ressources", "Je g√®re les conflits d'√©quipe de base et les probl√®mes de motivation"] },
          4: { label: 'Comp√©tent', criteria: ["Je constitue des √©quipes performantes √† travers les fonctions", "Je g√®re les conflits de ressources entre plusieurs projets", "Je d√©veloppe les membres de l'√©quipe et conduis les √©valuations de performance"] },
          5: { label: 'Expert', criteria: ["Je con√ßois des processus de gestion des ressources pour les BGP", "Je g√®re efficacement des organisations matricielles complexes", "Je coach d'autres GP sur le d√©veloppement d'√©quipe et le leadership"] }
        }
      },
      { 
        id: 'communication', name: 'Communication', description: 'Plans, rapports, r√©unions',
        rubric: {
          1: { label: 'Novice', criteria: ["Je n'ai jamais cr√©√© de plan de communication", "J'ai du mal √† r√©diger des rapports d'avancement clairs", "Je n'adapte pas ma communication aux diff√©rents publics"] },
          2: { label: 'D√©butant', criteria: ["Je comprends que diff√©rentes parties prenantes ont besoin d'informations diff√©rentes", "Je peux r√©diger un rapport d'avancement de base", "Je participe aux r√©unions projet mais je ne les dirige pas"] },
          3: { label: 'Interm√©diaire', criteria: ["Je cr√©e des plans de communication selon les besoins des parties prenantes", "Je r√©dige des r√©sum√©s ex√©cutifs et des rapports d√©taill√©s", "J'anime des r√©unions projet efficaces avec ordres du jour"] },
          4: { label: 'Comp√©tent', criteria: ["J'adapte mon style pour les ex√©cutifs, l'√©quipe et les clients", "Je livre les messages difficiles de fa√ßon professionnelle", "J'utilise des tableaux de bord et visuels pour communiquer l'avancement"] },
          5: { label: 'Expert', criteria: ["Je pr√©sente r√©guli√®rement √† la haute direction et aux CA", "Je coach d'autres sur la communication avec les parties prenantes", "Je con√ßois des cadres de communication pour les programmes"] }
        }
      },
      { 
        id: 'risk', name: 'Gestion des risques', description: 'Identification, analyse, r√©ponse',
        rubric: {
          1: { label: 'Novice', criteria: ["Je ne pense pas proactivement √† ce qui pourrait mal tourner", "Je n'ai jamais cr√©√© de registre des risques", "Je r√©agis aux probl√®mes plut√¥t que de les anticiper"] },
          2: { label: 'D√©butant', criteria: ["Je comprends que les risques ont une probabilit√© et un impact", "Je peux lister les risques projet √©vidents", "Je sais qu'on devrait avoir des plans de contingence"] },
          3: { label: 'Interm√©diaire', criteria: ["J'anime des ateliers d'identification des risques", "Je note les risques et les priorise avec une matrice de risques", "Je cr√©e des strat√©gies de r√©ponse (√©viter, transf√©rer, att√©nuer, accepter)"] },
          4: { label: 'Comp√©tent', criteria: ["Je quantifie les risques en utilisant la valeur mon√©taire attendue (VME)", "Je g√®re les r√©serves pour risques et les conditions de d√©clenchement", "J'identifie les risques secondaires et les risques r√©siduels"] },
          5: { label: 'Expert', criteria: ["J'utilise la simulation Monte Carlo pour l'analyse des risques", "Je con√ßois des cadres de gestion des risques pour des organisations", "Je g√®re les risques d'entreprise √† travers les portefeuilles"] }
        }
      },
      { 
        id: 'procurement', name: 'Approvisionnement', description: 'Contrats, fournisseurs, n√©gociation',
        rubric: {
          1: { label: 'Novice', criteria: ["Je n'ai jamais travaill√© avec des fournisseurs ou des contrats", "Je ne connais pas la diff√©rence entre AO, DAI et DI", "Je ne comprends pas les types de contrats (prix fixe, T&M)"] },
          2: { label: 'D√©butant', criteria: ["Je comprends qu'on a besoin de contrats pour le travail externe", "Je peux expliquer les bases prix fixe vs temps et mat√©riel", "J'ai particip√© √† une s√©lection de fournisseur mais je ne l'ai pas dirig√©e"] },
          3: { label: 'Interm√©diaire', criteria: ["Je peux r√©diger un AO et √©valuer les propositions des fournisseurs", "Je comprends quand utiliser diff√©rents types de contrats", "Je g√®re les relations fournisseurs et suis les livrables"] },
          4: { label: 'Comp√©tent', criteria: ["Je n√©gocie des contrats et obtiens des conditions favorables", "Je g√®re des relations fournisseurs complexes et les diff√©rends", "Je g√®re les modifications de contrat et les r√©clamations professionnellement"] },
          5: { label: 'Expert', criteria: ["Je con√ßois des strat√©gies d'approvisionnement pour de grands programmes", "J'ai g√©r√© des contrats fournisseurs de plus de 1M$", "Je forme d'autres sur l'approvisionnement et la n√©gociation"] }
        }
      },
      { 
        id: 'softskills', name: 'Leadership & comp√©tences relationnelles', description: 'Influence, conflit, motivation',
        rubric: {
          1: { label: 'Novice', criteria: ["J'√©vite les conflits plut√¥t que de les aborder", "J'ai du mal √† influencer sans autorit√© formelle", "Je n'ai jamais dirig√© d'√©quipes"] },
          2: { label: 'D√©butant', criteria: ["Je peux avoir des conversations difficiles avec du soutien", "Je comprends que diff√©rents styles de leadership existent", "Je me motive mais j'ai du mal √† motiver les autres"] },
          3: { label: 'Interm√©diaire', criteria: ["J'aborde les conflits de fa√ßon constructive et trouve des solutions", "J'influence les parties prenantes en utilisant donn√©es et relations", "J'adapte mon style de leadership √† la situation"] },
          4: { label: 'Comp√©tent', criteria: ["Je navigue efficacement la politique organisationnelle", "Je b√¢tis rapidement la confiance avec de nouvelles parties prenantes", "Je coach et d√©veloppe proactivement les membres de l'√©quipe"] },
          5: { label: 'Expert', criteria: ["On me consulte pour r√©soudre des conflits organisationnels complexes", "J'influence les cadres sup√©rieurs et conduis le changement", "Je mentor d'autres gestionnaires de projet sur le leadership"] }
        }
      }
    ];

    const STEPS = ['welcome', 'profile', 'objectives', 'assessment', 'results'];

    // ========== RESSOURCES PARTENAIRES - CONFIGURABLE ==========
    const PARTNER_RESOURCES = {
      thinkific: { name: 'Cours Executive Producer', url: 'https://the-executive-producer.thinkific.com', code: 'thinkific' },
      bizsimhub: { name: 'BizSimHub', url: 'https://simulations-six.vercel.app', code: 'bizsimhub' },
      pmtools: { name: 'ProjectManagerTool', url: 'https://projectmanagertool.com', code: 'pmtools' },
      mcgill: { name: 'McGill Formation continue', url: 'https://www.mcgill.ca/continuingstudies/', code: 'mcgill' },
      youtube: { name: 'YouTube', url: 'https://youtube.com', code: 'youtube' }
    };

    const RESOURCE_MAP = {
      basics: {
        courses: [
          { title: 'Fondamentaux GP', duration: '13 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' },
          { title: 'Certificat en gestion de projet', duration: '45 hrs', platform: 'McGill SCS', url: 'https://www.mcgill.ca/continuingstudies/fr/program/gestion-de-projet', partner: 'mcgill' }
        ],
        simulations: [],
        tools: [{ title: 'CharterPro', duration: '1 hr', platform: 'ProjectManagerTool', url: PARTNER_RESOURCES.pmtools.url, partner: 'pmtools' }],
        free: [{ title: "C'est quoi la gestion de projet?", duration: '15 min', platform: 'YouTube', url: 'https://www.youtube.com/results?search_query=gestion+de+projet+bases', partner: 'youtube' }]
      },
      agile: {
        courses: [{ title: 'Agile & GP Hybride', duration: '3.5 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Project Apex: Startup Tech', duration: '45 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [],
        free: [{ title: 'Scrum en 10 minutes', duration: '10 min', platform: 'YouTube', url: 'https://www.youtube.com/results?search_query=scrum+expliqu√©', partner: 'youtube' }]
      },
      product: {
        courses: [{ title: 'Produit, Ressources & Approvisionnement', duration: '2 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [],
        tools: [{ title: 'Calculateur ROI', duration: '30 min', platform: 'ProjectManagerTool', url: PARTNER_RESOURCES.pmtools.url, partner: 'pmtools' }],
        free: []
      },
      initiation: {
        courses: [{ title: 'D√©marrage & Gestion du contenu', duration: '2 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Project Apex: Startup Tech', duration: '45 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [{ title: 'CharterPro', duration: '1 hr', platform: 'ProjectManagerTool', url: PARTNER_RESOURCES.pmtools.url, partner: 'pmtools' }],
        free: []
      },
      scope: {
        courses: [{ title: 'D√©marrage & Gestion du contenu', duration: '2 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Project Apex: Construction', duration: '60 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [{ title: 'Cr√©ateur SDP', duration: '1 hr', platform: 'ProjectManagerTool', url: PARTNER_RESOURCES.pmtools.url + '?tool=wbs', partner: 'pmtools' }],
        free: [{ title: 'Comment cr√©er une SDP', duration: '20 min', platform: 'YouTube', url: 'https://www.youtube.com/results?search_query=structure+d√©coupage+projet', partner: 'youtube' }]
      },
      time: {
        courses: [{ title: 'Gestion temps & co√ªts', duration: '2.5 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Project Apex: Construction', duration: '60 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [{ title: 'Cr√©ateur Gantt', duration: '1 hr', platform: 'ProjectManagerTool', url: PARTNER_RESOURCES.pmtools.url + '?tool=gantt', partner: 'pmtools' }],
        free: [{ title: 'M√©thode chemin critique', duration: '15 min', platform: 'YouTube', url: 'https://www.youtube.com/results?search_query=chemin+critique+projet', partner: 'youtube' }]
      },
      cost: {
        courses: [{ title: 'Gestion valeur acquise', duration: '2.5 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Crise budg√©taire', duration: '45 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [{ title: 'Calculateur GVA', duration: '1 hr', platform: 'ProjectManagerTool', url: PARTNER_RESOURCES.pmtools.url + '?tool=evm', partner: 'pmtools' }],
        free: [{ title: 'GVA en 10 minutes', duration: '10 min', platform: 'YouTube', url: 'https://www.youtube.com/results?search_query=valeur+acquise+projet', partner: 'youtube' }]
      },
      quality: {
        courses: [{ title: 'Gestion qualit√© & risques', duration: '2 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [],
        tools: [{ title: 'G√©n√©rateur DMAIC', duration: '30 min', platform: 'ProjectManagerTool', url: PARTNER_RESOURCES.pmtools.url + '?tool=dmaic', partner: 'pmtools' }],
        free: []
      },
      resources: {
        courses: [{ title: 'Produit, Ressources & Approvisionnement', duration: '2 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Project Apex: Startup Tech', duration: '45 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [],
        free: []
      },
      communication: {
        courses: [{ title: 'Communication & comp√©tences relationnelles', duration: '2.5 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Project Apex: Innovation R&D', duration: '60 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [],
        free: []
      },
      risk: {
        courses: [{ title: 'Gestion qualit√© & risques', duration: '2 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Project Apex: Innovation R&D', duration: '60 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [{ title: 'Registre des risques', duration: '1 hr', platform: 'ProjectManagerTool', url: PARTNER_RESOURCES.pmtools.url + '?tool=risk', partner: 'pmtools' }],
        free: []
      },
      procurement: {
        courses: [{ title: 'Produit, Ressources & Approvisionnement', duration: '2 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [],
        tools: [],
        free: []
      },
      softskills: {
        courses: [{ title: 'Communication & comp√©tences relationnelles', duration: '2.5 hrs', platform: 'Executive Producer', url: PARTNER_RESOURCES.thinkific.url, partner: 'thinkific' }],
        simulations: [{ title: 'Project Apex: Startup Tech', duration: '45 min', platform: 'BizSimHub', url: PARTNER_RESOURCES.bizsimhub.url, partner: 'bizsimhub' }],
        tools: [],
        free: []
      }
    };

    // Track resource clicks for partner analytics
    async function trackResourceClick(partner, resource, url) {
      try {
        await fetch('/api/assessment/track-lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
          body: JSON.stringify({ assessmentId, partnerCode: partner, resourceClicked: resource })
        });
      } catch (e) { console.log('Track error:', e); }
      window.open(url, '_blank');
    }

    // Render functions
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <main class="max-w-4xl mx-auto py-8 px-6 fade-in">
          ${state.currentStep !== 'welcome' ? renderProgressIndicator() : ''}
          ${renderStep()}
        </main>
      `;
    }

    function renderProgressIndicator() {
      const steps = STEPS.filter(s => s !== 'welcome');
      const currentIndex = steps.indexOf(state.currentStep);
      const stepLabels = ['Profil', 'Objectifs', '√âvaluation', 'R√©sultats'];
      return `
        <div class="flex items-center justify-center gap-2 mb-8">
          ${steps.map((step, i) => `
            <div class="flex items-center">
              <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                i <= currentIndex ? 'bg-brand-500 text-white' : 'bg-[#1a1a2e] text-slate-400'
              }">${i + 1}</div>
              ${i < steps.length - 1 ? '<div class="w-8 h-0.5 bg-[#1a1a2e] mx-1"></div>' : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderStep() {
      switch(state.currentStep) {
        case 'welcome': return renderWelcome();
        case 'profile': return renderProfile();
        case 'objectives': return renderObjectives();
        case 'assessment': return renderAssessment();
        case 'results': return renderResults();
        default: return '';
      }
    }

    function renderWelcome() {
      return `
        <div class="text-center">
          <div class="text-6xl mb-6">üìä</div>
          <h1 class="text-4xl font-black text-white mb-4">√âvaluation des comp√©tences GP</h1>
          <p class="text-xl text-slate-300 mb-8 max-w-xl mx-auto">
            √âvaluez-vous sur 13 comp√©tences cl√©s en GP et obtenez une feuille de route de d√©veloppement personnalis√©e.
          </p>
          
          <div class="flex justify-center gap-8 mb-10">
            <div class="text-center">
              <div class="text-3xl font-bold text-white">13</div>
              <div class="text-sm text-slate-400">Comp√©tences</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-white">10</div>
              <div class="text-sm text-slate-400">Minutes</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-white">1</div>
              <div class="text-sm text-slate-400">Feuille de route</div>
            </div>
          </div>

          <button onclick="goToStep('profile')" class="bg-brand-500 hover:bg-brand-600 text-white font-bold py-4 px-12 rounded-lg text-lg transition-colors">
            Commencer l'√©valuation ‚Üí
          </button>

          <div class="mt-12 bg-[#131320] rounded-xl p-6 max-w-xl mx-auto text-left border border-[#1e1e35]">
            <h3 class="font-bold text-white mb-3 flex items-center gap-2">
              <span class="text-brand-500">üìã</span> Ce que couvre cette √©valuation
            </h3>
            <div class="space-y-2 text-sm text-slate-300">
              <p>‚Ä¢ <strong class="text-white">13 domaines de comp√©tences GP</strong> align√©s avec le PMBOK</p>
              <p>‚Ä¢ <strong class="text-white">Grilles d√©taill√©es</strong> pour vous aider √† vous auto-√©valuer avec pr√©cision</p>
              <p>‚Ä¢ <strong class="text-white">Feuille de route personnalis√©e</strong> bas√©e sur vos objectifs de carri√®re</p>
              <p>‚Ä¢ <strong class="text-white">Ressources s√©lectionn√©es</strong> parmi cours, simulations et outils</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderProfile() {
      const certs = ['PMP', 'CAPM', 'PMI-ACP', 'PRINCE2', 'Scrum Master', 'Aucune'];
      const isValid = state.profile.name && state.profile.title && state.profile.experience;
      
      return `
        <div>
          <h2 class="text-3xl font-bold text-white mb-2">√Ä propos de vous</h2>
          <p class="text-slate-300 mb-8">Aidez-nous √† personnaliser votre feuille de route de d√©veloppement.</p>

          <div class="bg-[#131320] rounded-xl p-8 border border-[#1e1e35]">
            <div class="grid gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Nom complet *</label>
                <input type="text" id="name" value="${state.profile.name}" 
                  oninput="updateProfile('name', this.value)"
                  class="w-full px-4 py-3 bg-[#1a1a2e] border border-[#2a2a45] rounded-lg text-white focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                  placeholder="Jean Tremblay">
              </div>

              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2">Titre d'emploi *</label>
                  <input type="text" id="title" value="${state.profile.title}"
                    oninput="updateProfile('title', this.value)"
                    class="w-full px-4 py-3 bg-[#1a1a2e] border border-[#2a2a45] rounded-lg text-white focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    placeholder="Gestionnaire de projet">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2">Organisation</label>
                  <input type="text" id="organization" value="${state.profile.organization}"
                    oninput="updateProfile('organization', this.value)"
                    class="w-full px-4 py-3 bg-[#1a1a2e] border border-[#2a2a45] rounded-lg text-white focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    placeholder="Acme Inc.">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Ann√©es d'exp√©rience en GP *</label>
                <select id="experience" onchange="updateProfile('experience', this.value)"
                  class="w-full px-4 py-3 bg-[#1a1a2e] border border-[#2a2a45] rounded-lg text-white focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                  <option value="">S√©lectionner...</option>
                  <option value="0-1" ${state.profile.experience === '0-1' ? 'selected' : ''}>0-1 an (Nouveau en GP)</option>
                  <option value="2-3" ${state.profile.experience === '2-3' ? 'selected' : ''}>2-3 ans (Quelque exp√©rience)</option>
                  <option value="4-5" ${state.profile.experience === '4-5' ? 'selected' : ''}>4-5 ans (Exp√©riment√©)</option>
                  <option value="6-10" ${state.profile.experience === '6-10' ? 'selected' : ''}>6-10 ans (Senior)</option>
                  <option value="10+" ${state.profile.experience === '10+' ? 'selected' : ''}>10+ ans (Expert)</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Certifications (s√©lectionner toutes celles qui s'appliquent)</label>
                <div class="flex flex-wrap gap-2">
                  ${certs.map(cert => `
                    <button onclick="toggleCert('${cert}')" class="px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                      state.profile.certifications.includes(cert)
                        ? 'bg-brand-500 text-white'
                        : 'bg-[#1a1a2e] text-slate-300 hover:bg-[#2a2a45]'
                    }">${cert}</button>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-between mt-8">
            <button onclick="goToStep('welcome')" class="text-slate-400 hover:text-white font-medium">‚Üê Retour</button>
            <button onclick="goToStep('objectives')" id="continueBtn" ${!isValid ? 'disabled' : ''} 
              class="font-bold py-3 px-8 rounded-lg transition-colors ${
                isValid ? 'bg-brand-500 hover:bg-brand-600 text-white' : 'bg-[#1a1a2e] text-slate-500 cursor-not-allowed'
              }">Continuer ‚Üí</button>
          </div>
        </div>
      `;
    }

    function renderObjectives() {
      const goals = [
        { value: 'exploring', icon: 'üîç', label: 'Explorer la gestion de projet', desc: "Je veux comprendre ce qu'est la GP", target: 3, targetLabel: '60%' },
        { value: 'support', icon: 'ü§ù', label: 'Soutenir mon r√¥le actuel', desc: "J'ai besoin de comp√©tences GP mais je n'aurai pas de titre GP", target: 3, targetLabel: '60%' },
        { value: 'job', icon: 'üíº', label: 'Obtenir un emploi de GP', desc: 'Je veux devenir un GP professionnel', target: 4, targetLabel: '80%' },
        { value: 'pmp', icon: 'üéì', label: 'Obtenir la certification PMP', desc: "Je veux r√©ussir l'examen PMP", target: 5, targetLabel: '90%+' },
        { value: 'improve', icon: 'üìà', label: "M'am√©liorer en tant que GP", desc: 'Je suis d√©j√† GP et je veux progresser', target: 4, targetLabel: '80%' }
      ];

      return `
        <div>
          <h2 class="text-3xl font-bold text-white mb-2">Quel est votre objectif?</h2>
          <p class="text-slate-300 mb-8">Cela nous aide √† d√©finir les bons niveaux de comp√©tence cibles pour votre √©valuation.</p>

          <div class="bg-[#131320] rounded-xl p-6 border border-[#1e1e35] mb-6">
            <div class="space-y-3">
              ${goals.map(goal => `
                <button onclick="setObjective('goal', '${goal.value}')" 
                  class="w-full p-4 rounded-xl border-2 text-left transition-all flex items-start gap-4 ${
                    state.objectives.goal === goal.value 
                      ? 'border-brand-500 bg-brand-500/10' 
                      : 'border-[#1e1e35] hover:border-[#2a2a45]'
                  }">
                  <div class="text-3xl">${goal.icon}</div>
                  <div class="flex-1">
                    <div class="font-bold text-white">${goal.label}</div>
                    <div class="text-sm text-slate-400">${goal.desc}</div>
                  </div>
                  <div class="text-xs text-slate-400">Cible: ${goal.targetLabel}</div>
                </button>
              `).join('')}
            </div>
          </div>

          <div class="flex justify-between mt-8">
            <button onclick="goToStep('profile')" class="text-slate-400 hover:text-white font-medium">‚Üê Retour</button>
            <button onclick="goToStep('assessment')" ${!state.objectives.goal ? 'disabled' : ''}
              class="font-bold py-3 px-8 rounded-lg transition-colors ${
                state.objectives.goal ? 'bg-brand-500 hover:bg-brand-600 text-white' : 'bg-[#1a1a2e] text-slate-500 cursor-not-allowed'
              }">Continuer ‚Üí</button>
          </div>
        </div>
      `;
    }

    function renderAssessment() {
      const completed = Object.keys(state.scores).length;
      const progress = (completed / SKILL_AREAS.length) * 100;
      const allScored = SKILL_AREAS.every(s => state.scores[s.id] !== undefined);

      return `
        <div>
          <div class="flex justify-between items-start mb-4">
            <div>
              <h2 class="text-3xl font-bold text-white mb-2">√âvaluation des comp√©tences</h2>
              <p class="text-slate-300">√âvaluez votre niveau actuel dans chaque domaine.</p>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-brand-500">${completed}/13</div>
              <div class="text-sm text-slate-400">Compl√©t√©</div>
            </div>
          </div>

          <div class="bg-brand-500/20 border border-brand-500/30 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <span class="text-brand-400 text-xl">üí°</span>
              <div class="text-sm text-slate-300">
                <strong>Comment vous √©valuer:</strong> Cliquez sur "Voir les crit√®res" sur n'importe quelle comp√©tence pour voir exactement ce que chaque niveau signifie. 
                Soyez honn√™te ‚Äî cela nous aide √† cr√©er la meilleure feuille de route pour vous!
              </div>
            </div>
          </div>

          <div class="w-full h-2 bg-[#1a1a2e] rounded-full mb-6">
            <div class="h-full bg-brand-500 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
          </div>

          <div class="space-y-4">
            ${SKILL_AREAS.map((skill, idx) => renderSkillCard(skill, idx)).join('')}
          </div>

          <div class="flex justify-between mt-8">
            <button onclick="goToStep('objectives')" class="text-slate-400 hover:text-white font-medium">‚Üê Retour</button>
            <button onclick="goToStep('results')" ${!allScored ? 'disabled' : ''}
              class="font-bold py-3 px-8 rounded-lg transition-colors ${
                allScored ? 'bg-brand-500 hover:bg-brand-600 text-white' : 'bg-[#1a1a2e] text-slate-500 cursor-not-allowed'
              }">Voir mes r√©sultats ‚Üí</button>
          </div>
        </div>
      `;
    }

    function renderSkillCard(skill, idx) {
      const isExpanded = state.expandedSkill === skill.id;
      const currentScore = state.scores[skill.id];
      
      return `
        <div class="bg-[#131320] rounded-xl border-2 transition-all ${
          currentScore !== undefined ? 'border-brand-500/50' : 'border-[#1e1e35]'
        }">
          <div class="p-6">
            <div class="flex justify-between items-start mb-4">
              <div class="flex items-center gap-3">
                <span class="w-8 h-8 bg-[#1a1a2e] text-white rounded-full flex items-center justify-center text-sm font-bold">${idx + 1}</span>
                <div>
                  <h3 class="text-lg font-bold text-white">${skill.name}</h3>
                  <p class="text-sm text-slate-400">${skill.description}</p>
                </div>
              </div>
              ${currentScore !== undefined ? `
                <div class="text-right">
                  <div class="text-2xl font-bold text-brand-500">${currentScore}</div>
                  <div class="text-xs text-slate-300">${skill.rubric[currentScore].label}</div>
                </div>
              ` : ''}
            </div>

            <div class="flex gap-2 mb-3">
              ${[1,2,3,4,5].map(v => `
                <button onclick="setScore('${skill.id}', ${v})" 
                  class="flex-1 py-3 rounded-lg text-sm font-medium transition-all ${
                    currentScore === v
                      ? 'bg-brand-500 text-white shadow-lg scale-105'
                      : 'bg-[#1a1a2e] text-slate-300 hover:bg-[#2a2a45]'
                  }">
                  <div class="font-bold">${v}</div>
                  <div class="text-xs opacity-75">${skill.rubric[v].label}</div>
                </button>
              `).join('')}
            </div>

            <button onclick="toggleExpanded('${skill.id}')" 
              class="text-sm text-brand-400 hover:text-brand-300 font-medium flex items-center gap-1">
              ${isExpanded ? '‚ñº Masquer' : '‚ñ∂ Voir'} les crit√®res pour vous aider √† d√©cider
            </button>
          </div>

          ${isExpanded ? `
            <div class="border-t border-[#1e1e35] bg-[#0b0b14] p-6">
              <div class="grid gap-4">
                ${[1,2,3,4,5].map(level => `
                  <div class="flex gap-4 ${currentScore === level ? 'bg-brand-500/10 -mx-4 px-4 py-3 rounded-lg' : ''}">
                    <div class="flex-shrink-0">
                      <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${
                        currentScore === level ? 'bg-brand-500 text-white' : 'bg-[#1a1a2e] text-slate-300'
                      }">${level}</div>
                    </div>
                    <div class="flex-1">
                      <div class="font-bold text-white mb-1">${skill.rubric[level].label}</div>
                      <ul class="text-sm text-slate-300 space-y-1">
                        ${skill.rubric[level].criteria.map(c => `<li class="flex items-start gap-2"><span class="text-slate-500 mt-0.5">‚Ä¢</span><span>${c}</span></li>`).join('')}
                      </ul>
                      <button onclick="setScore('${skill.id}', ${level})" class="mt-2 text-xs font-medium ${currentScore === level ? 'text-brand-400' : 'text-slate-500 hover:text-brand-400'}">
                        ${currentScore === level ? '‚úì S√©lectionn√©' : 'S√©lectionner ce niveau'}
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderResults() {
      const goals = {
        exploring: { label: 'Explorer la GP', icon: 'üîç', target: 3 },
        support: { label: 'Soutenir mon r√¥le', icon: 'ü§ù', target: 3 },
        job: { label: 'Emploi GP', icon: 'üíº', target: 4 },
        pmp: { label: 'Certification PMP', icon: 'üéì', target: 5 },
        improve: { label: "M'am√©liorer", icon: 'üìà', target: 4 }
      };
      
      const currentGoal = goals[state.objectives.goal] || goals.job;
      const overallScore = calculateOverallScore();
      const gaps = getGaps();
      const topGaps = gaps.slice(0, 5);
      const strengths = SKILL_AREAS.filter(s => state.scores[s.id] >= currentGoal.target);
      const roadmap = generateRoadmap();

      // Save assessment
      saveAssessment(overallScore, gaps.length, strengths.length);

      return `
        <div>
          <div class="bg-[#131320] -mx-6 -mt-8 px-6 py-8 mb-8 rounded-b-3xl border-b border-[#1e1e35]">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h2 class="text-3xl font-bold text-white mb-2">Vos r√©sultats</h2>
                <p class="text-slate-300">√âvaluation pour ${state.profile.name}</p>
              </div>
              <div class="text-right">
                <div class="text-3xl">${currentGoal.icon}</div>
                <div class="text-sm text-slate-300">Objectif: ${currentGoal.label}</div>
              </div>
            </div>
            
            <div class="grid md:grid-cols-4 gap-4 mt-6">
              <div class="bg-[#1a1a2e] rounded-xl p-4">
                <div class="text-4xl font-black ${overallScore >= 80 ? 'text-green-500' : overallScore >= 60 ? 'text-yellow-500' : 'text-red-500'}">${overallScore}%</div>
                <div class="text-sm text-slate-300">Score global</div>
              </div>
              <div class="bg-[#1a1a2e] rounded-xl p-4">
                <div class="text-4xl font-black text-brand-500">${gaps.length}</div>
                <div class="text-sm text-slate-300">√âcarts de comp√©tences</div>
              </div>
              <div class="bg-[#1a1a2e] rounded-xl p-4">
                <div class="text-4xl font-black text-white">${state.objectives.timeline}</div>
                <div class="text-sm text-slate-300">Semaines de plan</div>
              </div>
              <div class="bg-[#1a1a2e] rounded-xl p-4">
                <div class="text-4xl font-black text-green-500">${strengths.length}</div>
                <div class="text-sm text-slate-300">Forces</div>
              </div>
            </div>
          </div>

          <!-- R√©partition des comp√©tences -->
          <div class="bg-[#131320] rounded-xl p-6 border border-[#1e1e35] mb-6">
            <h3 class="font-bold text-white mb-4">R√©partition des comp√©tences</h3>
            <div class="space-y-3">
              ${SKILL_AREAS.map(skill => {
                const score = state.scores[skill.id] || 0;
                const barColor = score >= 4 ? 'bg-green-500' : score >= 3 ? 'bg-yellow-500' : 'bg-red-500';
                const textColor = score >= 4 ? 'text-green-500' : score >= 3 ? 'text-yellow-500' : 'text-red-500';
                return `
                  <div class="flex items-center gap-4">
                    <div class="w-40 text-sm text-slate-300 truncate">${skill.name}</div>
                    <div class="flex-1 h-3 bg-[#1a1a2e] rounded-full overflow-hidden">
                      <div class="${barColor} h-full transition-all duration-500" style="width: ${score * 20}%"></div>
                    </div>
                    <div class="w-12 text-right font-bold ${textColor}">${score * 20}%</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Domaines prioritaires -->
          <div class="bg-[#131320] rounded-xl p-6 border border-[#1e1e35] mb-6">
            <h3 class="font-bold text-white mb-4">Domaines de d√©veloppement prioritaires</h3>
            <div class="space-y-3">
              ${topGaps.length > 0 ? topGaps.map((gap, i) => `
                <div class="flex items-center justify-between p-4 bg-[#1a1a2e] rounded-lg">
                  <div class="flex items-center gap-3">
                    <span class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold ${
                      i === 0 ? 'bg-red-500' : 'bg-yellow-500'
                    }">${i + 1}</span>
                    <div>
                      <div class="font-medium text-white">${gap.name}</div>
                      <div class="text-sm text-slate-400">Actuel: ${gap.current * 20}% ‚Üí Cible: ${gap.target * 20}%</div>
                    </div>
                  </div>
                  <div class="text-lg font-bold ${i === 0 ? 'text-red-500' : 'text-yellow-500'}">+${gap.gap * 20}%</div>
                </div>
              `).join('') : `
                <div class="text-center py-8 text-slate-400">
                  üéâ Incroyable! Vous avez d√©j√† atteint votre niveau cible dans tous les domaines!
                </div>
              `}
            </div>
          </div>

          <!-- Pr√©f√©rences de la feuille de route -->
          <div class="bg-[#131320] rounded-xl p-6 border border-[#1e1e35] mb-6">
            <h3 class="font-bold text-white mb-4">Personnaliser votre feuille de route</h3>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Dur√©e</label>
                <div class="flex gap-2">
                  ${[{ value: '8', label: '8 sem' }, { value: '12', label: '12 sem' }, { value: '16', label: '16 sem' }].map(opt => `
                    <button onclick="updatePreference('timeline', '${opt.value}')"
                      class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all ${
                        state.objectives.timeline === opt.value ? 'bg-brand-500 text-white' : 'bg-[#1a1a2e] text-slate-300 hover:bg-[#2a2a45]'
                      }">${opt.label}</button>
                  `).join('')}
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Style d'apprentissage</label>
                <div class="flex gap-2">
                  ${[{ value: 'video', label: 'üìπ Vid√©o' }, { value: 'hands-on', label: 'üõ† Pratique' }, { value: 'balanced', label: '‚öñÔ∏è √âquilibr√©' }].map(opt => `
                    <button onclick="updatePreference('learningStyle', '${opt.value}')"
                      class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all ${
                        state.objectives.learningStyle === opt.value ? 'bg-brand-500 text-white' : 'bg-[#1a1a2e] text-slate-300 hover:bg-[#2a2a45]'
                      }">${opt.label}</button>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>

          <!-- Feuille de route personnalis√©e -->
          <div class="bg-[#131320] rounded-xl p-6 border border-[#1e1e35] mb-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-bold text-white text-xl">Votre feuille de route de ${state.objectives.timeline} semaines</h3>
              <span class="text-sm text-slate-400">${roadmap.totalHours} heures au total</span>
            </div>

            <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
              ${roadmap.phases.map(phase => `
                <div class="flex-1 min-w-[120px]">
                  <div class="h-2 rounded-full ${phase.color}"></div>
                  <div class="mt-2 text-xs font-medium text-slate-300">${phase.name}</div>
                  <div class="text-xs text-slate-400">Sem. ${phase.weeks}</div>
                </div>
              `).join('')}
            </div>

            <div class="space-y-3">
              ${roadmap.steps.map((step, i) => `
                <div class="flex items-start gap-4 p-4 rounded-lg ${i % 2 === 0 ? 'bg-[#1a1a2e]' : 'bg-[#1a1a2e]/50'} border border-[#2a2a45]">
                  <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full bg-slate-600 text-white flex items-center justify-center text-sm font-bold">${i + 1}</div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="px-2 py-0.5 rounded text-xs font-bold ${step.typeBadgeClass}">${step.type}</span>
                      <button onclick="trackResourceClick('${step.partner}', '${step.title}', '${step.url}')" class="font-medium text-white hover:text-brand-500 transition-colors">
                        ${step.title} ‚Üí
                      </button>
                    </div>
                    <div class="text-sm text-slate-400">${step.description}</div>
                    <div class="flex items-center gap-4 mt-2 text-xs text-slate-500">
                      <span>üìç ${step.platform}</span>
                      <span>‚è± ${step.duration}</span>
                      <span>üìÖ Sem. ${step.week}</span>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="mt-6 pt-6 border-t border-[#1e1e35]">
              <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-2xl font-bold text-green-500">${roadmap.counts.courses}</div>
                  <div class="text-xs text-slate-400">Cours</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-purple-500">${roadmap.counts.simulations}</div>
                  <div class="text-xs text-slate-400">Simulations</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-cyan-500">${roadmap.counts.tools}</div>
                  <div class="text-xs text-slate-400">Outils</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Liens des plateformes -->
          <div class="bg-[#131320] rounded-xl p-6 border border-[#1e1e35] mb-6">
            <h3 class="font-bold text-white mb-4">O√π acc√©der √† vos ressources</h3>
            <div class="grid md:grid-cols-3 gap-4">
              <a href="${PARTNER_RESOURCES.thinkific.url}" target="_blank" class="p-4 bg-green-500/10 rounded-lg border border-green-500/30 hover:border-green-500 transition-colors">
                <div class="text-2xl mb-2">üìö</div>
                <div class="font-medium text-white">Cours de formation</div>
                <div class="text-sm text-slate-400">the-executive-producer.com</div>
                <div class="text-xs text-green-400 mt-2">${roadmap.counts.courses} cours dans votre plan ‚Üí</div>
              </a>
              <a href="${PARTNER_RESOURCES.bizsimhub.url}" target="_blank" class="p-4 bg-purple-500/10 rounded-lg border border-purple-500/30 hover:border-purple-500 transition-colors">
                <div class="text-2xl mb-2">üéÆ</div>
                <div class="font-medium text-white">Simulations</div>
                <div class="text-sm text-slate-400">bizsimlive.com</div>
                <div class="text-xs text-purple-400 mt-2">${roadmap.counts.simulations} simulations dans votre plan ‚Üí</div>
              </a>
              <a href="${PARTNER_RESOURCES.pmtools.url}" target="_blank" class="p-4 bg-cyan-500/10 rounded-lg border border-cyan-500/30 hover:border-cyan-500 transition-colors">
                <div class="text-2xl mb-2">üõ†</div>
                <div class="font-medium text-white">Outils GP</div>
                <div class="text-sm text-slate-400">projectmanagertool.com</div>
                <div class="text-xs text-cyan-400 mt-2">${roadmap.counts.tools} outils dans votre plan ‚Üí</div>
              </a>
            </div>
          </div>

          <!-- CTA T√©l√©charger -->
          <div class="bg-gradient-to-r from-brand-600 to-brand-500 rounded-xl p-8 text-center text-white">
            <h3 class="text-2xl font-bold mb-2">Sauvegardez votre feuille de route</h3>
            <p class="mb-6 opacity-90">T√©l√©chargez un PDF joliment format√© pour suivre votre progression et partager avec votre gestionnaire.</p>
            <button onclick="generateReport()" id="downloadBtn" class="bg-white text-brand-600 font-bold py-4 px-12 rounded-lg hover:bg-slate-100 transition-colors">
              üìÑ T√©l√©charger le rapport PDF
            </button>
          </div>

          <div class="flex justify-between mt-8">
            <button onclick="goToStep('assessment')" class="text-slate-400 hover:text-white font-medium">‚Üê Retour</button>
            <button onclick="location.reload()" class="text-slate-400 hover:text-white font-medium">Recommencer</button>
          </div>
        </div>
      `;
    }

    // Helper functions
    function calculateOverallScore() {
      const values = Object.values(state.scores);
      if (values.length === 0) return 0;
      return Math.round((values.reduce((a, b) => a + b, 0) / values.length) * 20);
    }

    function getGaps() {
      const targetByGoal = { exploring: 3, support: 3, job: 4, pmp: 5, improve: 4 };
      const target = targetByGoal[state.objectives.goal] || 4;
      
      return SKILL_AREAS
        .map(skill => ({ ...skill, current: state.scores[skill.id] || 0, target, gap: target - (state.scores[skill.id] || 0) }))
        .filter(s => s.gap > 0)
        .sort((a, b) => b.gap - a.gap);
    }

    function generateRoadmap() {
      const gaps = getGaps().slice(0, 5);
      const weeks = parseInt(state.objectives.timeline);
      const learningStyle = state.objectives.learningStyle;
      
      const phases = [
        { name: 'Fondation', weeks: `1-${Math.floor(weeks/3)}`, color: 'bg-blue-500' },
        { name: 'Construction', weeks: `${Math.floor(weeks/3)+1}-${Math.floor(2*weeks/3)}`, color: 'bg-purple-500' },
        { name: 'Application', weeks: `${Math.floor(2*weeks/3)+1}-${weeks}`, color: 'bg-green-500' }
      ];

      const typeBadges = {
        'COURS': 'bg-green-500/20 text-green-400',
        'SIMULATION': 'bg-purple-500/20 text-purple-400',
        'OUTIL': 'bg-cyan-500/20 text-cyan-400',
        'GRATUIT': 'bg-yellow-500/20 text-yellow-400',
        '√âVALUER': 'bg-brand-500/20 text-brand-400'
      };

      const steps = [];
      let currentWeek = 1;
      let courseCount = 0, simCount = 0, toolCount = 0;
      let totalHours = 0;
      const weeksPerGap = Math.floor(weeks / Math.max(gaps.length, 1));

      gaps.forEach((gap, gapIdx) => {
        const resources = RESOURCE_MAP[gap.id] || { courses: [], simulations: [], tools: [], free: [] };
        const skillName = gap.name;

        if (resources.free && resources.free.length > 0) {
          const free = resources.free[0];
          steps.push({
            type: 'GRATUIT', title: free.title, description: 'Contenu intro gratuit pour commencer',
            platform: free.platform, duration: free.duration, week: currentWeek, skill: skillName,
            url: free.url || '#', partner: free.partner || 'youtube',
            typeBadgeClass: typeBadges['GRATUIT']
          });
          totalHours += 0.5;
        }

        if (resources.courses.length > 0 && (learningStyle === 'video' || learningStyle === 'balanced')) {
          const course = resources.courses[0];
          steps.push({
            type: 'COURS', title: course.title, description: 'Formation compl√®te avec le√ßons vid√©o et quiz',
            platform: course.platform, duration: course.duration, week: currentWeek, skill: skillName,
            url: course.url || '#', partner: course.partner || 'thinkific',
            typeBadgeClass: typeBadges['COURS']
          });
          totalHours += parseFloat(course.duration) || 2;
          courseCount++;
        }

        if (resources.tools.length > 0 && (learningStyle === 'hands-on' || learningStyle === 'balanced')) {
          const tool = resources.tools[0];
          steps.push({
            type: 'OUTIL', title: tool.title, description: 'Pratiquez avec un outil GP professionnel',
            platform: tool.platform, duration: tool.duration, week: currentWeek + Math.floor(weeksPerGap / 2), skill: skillName,
            url: tool.url || '#', partner: tool.partner || 'pmtools',
            typeBadgeClass: typeBadges['OUTIL']
          });
          totalHours += parseFloat(tool.duration) || 1;
          toolCount++;
        }

        if (resources.simulations.length > 0 && (learningStyle === 'hands-on' || learningStyle === 'balanced')) {
          const sim = resources.simulations[0];
          steps.push({
            type: 'SIMULATION', title: sim.title, description: 'Appliquez les comp√©tences dans une simulation r√©aliste',
            platform: sim.platform, duration: sim.duration, week: currentWeek + weeksPerGap - 1, skill: skillName,
            url: sim.url || '#', partner: sim.partner || 'bizsimhub',
            typeBadgeClass: typeBadges['SIMULATION']
          });
          totalHours += 1;
          simCount++;
        }

        currentWeek += weeksPerGap;
      });

      steps.push({
        type: '√âVALUER', title: 'R√©√©valuez vos comp√©tences', description: 'Refaites l\'√©valuation pour mesurer votre progression',
        platform: 'pmskillsassess.com', duration: '10 min', week: weeks, skill: 'Tous',
        url: '/assessment-fr.html', partner: '',
        typeBadgeClass: typeBadges['√âVALUER']
      });

      steps.sort((a, b) => a.week - b.week);

      return {
        phases,
        steps: steps.slice(0, 12),
        totalHours: Math.round(totalHours),
        counts: { courses: courseCount, simulations: simCount, tools: toolCount }
      };
    }

    async function saveAssessment(overallScore, gapCount, strengthCount) {
      try {
        const response = await fetch('/api/assessment/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
          body: JSON.stringify({
            profile: state.profile,
            objectives: state.objectives,
            scores: state.scores,
            overallScore,
            gapCount,
            strengthCount
          })
        });
        if (response.ok) {
          const data = await response.json();
          assessmentId = data.assessmentId;
        }
      } catch (e) { console.log('Save error:', e); }
    }

    async function generateReport() {
      const btn = document.getElementById('downloadBtn');
      btn.innerHTML = 'G√©n√©ration...';
      btn.disabled = true;
      
      await new Promise(r => setTimeout(r, 300));
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const margin = 20;
        const pageWidth = 210;
        const contentWidth = pageWidth - margin * 2;
        const goals = { exploring: { icon: 'üîç', label: 'Explorer la GP', target: 3 }, support: { icon: 'ü§ù', label: 'Soutenir mon r√¥le', target: 3 }, job: { icon: 'üíº', label: 'Emploi GP', target: 4 }, pmp: { icon: 'üéì', label: 'Certification PMP', target: 5 }, improve: { icon: 'üìà', label: "M'am√©liorer", target: 4 } };
        const currentGoal = goals[state.objectives.goal] || goals.improve;

        function addFooter(doc, pageNum) {
          doc.setFontSize(8);
          doc.setTextColor(150, 150, 150);
          doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-CA')} | PM SkillsAssess`, margin, 285);
          doc.text(`Page ${pageNum}`, pageWidth - margin - 10, 285);
        }

        function checkNewPage(doc, y, needed) {
          if (y + needed > 270) {
            addFooter(doc, doc.getNumberOfPages());
            doc.addPage();
            return 20;
          }
          return y;
        }
        
        // === PAGE 1: En-t√™te + Score + Comp√©tences ===
        doc.setFillColor(26, 26, 26);
        doc.rect(0, 0, pageWidth, 45, 'F');
        doc.setFontSize(22);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(255, 255, 255);
        doc.text('√âVALUATION COMP√âTENCES GP', margin, 20);
        doc.setFontSize(12);
        doc.setTextColor(200, 200, 200);
        doc.text(`Rapport pour ${state.profile.name}`, margin, 30);
        doc.setFontSize(10);
        doc.text(`${state.profile.title || ''} ${state.profile.organization ? '| ' + state.profile.organization : ''} | ${state.profile.experience || ''} d'exp√©rience`, margin, 38);
        
        let y = 55;
        
        // Score global + Objectif
        const overallScore = calculateOverallScore();
        doc.setFontSize(42);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(99, 102, 241);
        doc.text(`${overallScore}%`, margin, y);
        doc.setFontSize(14);
        doc.setTextColor(100, 100, 100);
        doc.text('Score global', margin + 38, y - 8);
        doc.setFontSize(11);
        doc.setTextColor(120, 120, 120);
        doc.text(`Objectif: ${currentGoal.label} | Cible: Niveau ${currentGoal.target}/5`, margin + 38, y);
        
        y += 15;

        // R√©sum√© lacunes & forces
        const gaps = getGaps();
        const strengths = SKILL_AREAS.filter(s => (state.scores[s.id] || 0) >= currentGoal.target);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(239, 68, 68);
        doc.text(`${gaps.length} lacunes identifi√©es`, margin, y);
        doc.setTextColor(16, 185, 129);
        doc.text(`${strengths.length} forces`, margin + 50, y);
        
        y += 15;
        
        // Ventilation des comp√©tences
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(50, 50, 50);
        doc.text('Ventilation des comp√©tences', margin, y);
        y += 3;

        doc.setFontSize(7);
        doc.setTextColor(150, 150, 150);
        doc.text(`Cible: Niveau ${currentGoal.target}`, margin + 50 + 80 * (currentGoal.target / 5) - 8, y + 3);
        y += 7;
        
        SKILL_AREAS.forEach(skill => {
          const score = state.scores[skill.id] || 0;
          const isGap = score < currentGoal.target;
          doc.setFontSize(9);
          doc.setFont('helvetica', isGap ? 'bold' : 'normal');
          doc.setTextColor(isGap ? 200 : 80, isGap ? 60 : 80, isGap ? 60 : 80);
          doc.text(skill.name, margin, y);
          
          const levelLabels = ['', 'Novice', 'D√©butant', 'Interm√©diaire', 'Comp√©tent', 'Expert'];
          doc.setFontSize(7);
          doc.setTextColor(130, 130, 130);
          doc.text(levelLabels[score] || '', pageWidth - margin - 22, y);
          doc.setFontSize(9);
          doc.setTextColor(80, 80, 80);
          doc.text(`${score * 20}%`, pageWidth - margin - 5, y);
          
          doc.setFillColor(220, 220, 220);
          doc.rect(margin + 50, y - 3, 80, 4, 'F');
          const barColor = score >= 4 ? [16, 185, 129] : score >= 3 ? [245, 158, 11] : [239, 68, 68];
          doc.setFillColor(...barColor);
          doc.rect(margin + 50, y - 3, 80 * (score / 5), 4, 'F');

          const targetX = margin + 50 + 80 * (currentGoal.target / 5);
          doc.setDrawColor(100, 100, 100);
          doc.setLineWidth(0.3);
          doc.line(targetX, y - 4, targetX, y + 1);
          
          y += 8;
        });
        
        addFooter(doc, 1);

        // === PAGE 2: Feuille de route ===
        doc.addPage();
        y = 20;

        doc.setFillColor(26, 26, 26);
        doc.rect(0, 0, pageWidth, 30, 'F');
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(255, 255, 255);
        doc.text('VOTRE FEUILLE DE ROUTE', margin, 20);
        y = 40;

        const roadmap = generateRoadmap();

        // Phases
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(50, 50, 50);
        doc.text('Phases d\'apprentissage', margin, y);
        y += 8;

        const phaseColors = [[16, 185, 129], [59, 130, 246], [168, 85, 247]];
        const phaseNamesFr = ['Fondations', 'D√©veloppement', 'Application'];
        roadmap.phases.forEach((phase, i) => {
          const phaseWidth = contentWidth / 3;
          const px = margin + i * phaseWidth;
          doc.setFillColor(...phaseColors[i]);
          doc.rect(px + 1, y, phaseWidth - 2, 12, 'F');
          doc.setFontSize(9);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(255, 255, 255);
          doc.text(phaseNamesFr[i], px + 4, y + 5);
          doc.setFontSize(7);
          doc.text(`Semaines ${phase.weeks}`, px + 4, y + 10);
        });
        y += 20;

        // Statistiques
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(80, 80, 80);
        doc.text(`Total: ${roadmap.totalHours} heures | ${roadmap.counts.courses} cours | ${roadmap.counts.simulations} simulations | ${roadmap.counts.tools} outils`, margin, y);
        y += 12;

        // Lacunes prioritaires
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(50, 50, 50);
        doc.text('Lacunes prioritaires', margin, y);
        y += 8;

        gaps.slice(0, 5).forEach((gap, i) => {
          y = checkNewPage(doc, y, 12);
          doc.setFillColor(254, 242, 242);
          doc.rect(margin, y - 4, contentWidth, 10, 'F');
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(180, 50, 50);
          doc.text(`${i + 1}. ${gap.name}`, margin + 3, y + 2);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(120, 80, 80);
          doc.text(`Actuel: Niveau ${gap.score}/5 | Cible: Niveau ${currentGoal.target}/5 | √âcart: ${currentGoal.target - gap.score} niveaux`, margin + 60, y + 2);
          y += 12;
        });
        y += 5;

        // Parcours recommand√©
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(50, 50, 50);
        y = checkNewPage(doc, y, 15);
        doc.text('Parcours d\'apprentissage recommand√©', margin, y);
        y += 8;

        const typeColors = {
          'WATCH': [59, 130, 246], 'COURSE': [16, 185, 129], 'TOOL': [6, 182, 212],
          'SIMULATE': [168, 85, 247], 'APPLY': [245, 158, 11], 'ASSESS': [99, 102, 241]
        };
        const typeLabelsFr = {
          'WATCH': 'VID√âO', 'COURSE': 'COURS', 'TOOL': 'OUTIL',
          'SIMULATE': 'SIMULATION', 'APPLY': 'PRATIQUE', 'ASSESS': '√âVALUER'
        };

        roadmap.steps.forEach((step, i) => {
          y = checkNewPage(doc, y, 18);
          
          const badgeColor = typeColors[step.type] || [100, 100, 100];
          const badgeLabel = typeLabelsFr[step.type] || step.type;
          doc.setFillColor(...badgeColor);
          doc.roundedRect(margin, y - 3, 22, 5, 1, 1, 'F');
          doc.setFontSize(6);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(255, 255, 255);
          doc.text(badgeLabel, margin + 2, y);

          doc.setFontSize(7);
          doc.setTextColor(150, 150, 150);
          doc.text(`Sem. ${step.week}`, margin + 24, y);

          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(40, 40, 40);
          doc.text(step.title, margin + 38, y);

          y += 5;
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(100, 100, 100);
          doc.text(`${step.skill} | ${step.platform} | ${step.duration}`, margin + 38, y);

          y += 8;
        });

        addFooter(doc, 2);

        // === PAGE 3: Forces & Prochaines √©tapes ===
        if (strengths.length > 0) {
          doc.addPage();
          y = 20;

          doc.setFillColor(26, 26, 26);
          doc.rect(0, 0, pageWidth, 30, 'F');
          doc.setFontSize(20);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(255, 255, 255);
          doc.text('FORCES & PROCHAINES √âTAPES', margin, 20);
          y = 40;

          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(50, 50, 50);
          doc.text('Vos forces', margin, y);
          y += 8;

          strengths.forEach(s => {
            const score = state.scores[s.id] || 0;
            doc.setFillColor(236, 253, 245);
            doc.rect(margin, y - 4, contentWidth, 8, 'F');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(20, 120, 80);
            doc.text(`‚úì ${s.name} ‚Äî Niveau ${score}/5`, margin + 3, y + 1);
            y += 10;
          });

          y += 10;
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(50, 50, 50);
          doc.text('Prochaines √©tapes', margin, y);
          y += 8;

          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(80, 80, 80);
          const nextSteps = [
            '1. Commencez par la lacune prioritaire et compl√©tez le cours recommand√©',
            '2. Pratiquez avec les outils et simulations pour chaque comp√©tence',
            '3. Appliquez vos apprentissages sur vos projets en cours',
            `4. R√©√©valuez vos comp√©tences dans ${state.objectives.timeline || 12} semaines`,
            '5. Partagez votre feuille de route avec votre gestionnaire'
          ];
          nextSteps.forEach(step => {
            doc.text(step, margin, y);
            y += 7;
          });

          addFooter(doc, 3);
        }
        
        const fileName = `Evaluation_GP_${state.profile.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
      } catch (error) {
        console.error('Erreur PDF:', error);
        alert('Erreur lors de la g√©n√©ration du PDF: ' + error.message);
      }
      
      btn.innerHTML = 'üìÑ T√©l√©charger le rapport PDF';
      btn.disabled = false;
    }

    // Event handlers
    function goToStep(step) { state.currentStep = step; render(); window.scrollTo(0, 0); }
    function toggleCert(cert) {
      if (state.profile.certifications.includes(cert)) {
        state.profile.certifications = state.profile.certifications.filter(c => c !== cert);
      } else {
        state.profile.certifications.push(cert);
      }
      render();
    }
    function setScore(skillId, value) { state.scores[skillId] = value; render(); }
    function toggleExpanded(skillId) { state.expandedSkill = state.expandedSkill === skillId ? null : skillId; render(); }
    function setObjective(key, value) { state.objectives[key] = value; render(); }
    function updatePreference(key, value) { state.objectives[key] = value; render(); }
    function updateProfile(field, value) {
      state.profile[field] = value;
      const isValid = state.profile.name && state.profile.title && state.profile.experience;
      const btn = document.getElementById('continueBtn');
      if (btn) {
        btn.disabled = !isValid;
        btn.className = `font-bold py-3 px-8 rounded-lg transition-colors ${isValid ? 'bg-brand-500 hover:bg-brand-600 text-white' : 'bg-[#1a1a2e] text-slate-500 cursor-not-allowed'}`;
      }
    }

    // Initialize
    checkAuth().then(isAuth => { if (isAuth) render(); });
  </script>
</body>
</html>
